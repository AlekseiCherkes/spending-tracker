# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Core Development Workflow
```bash
# MANDATORY: Run after completing every task
./scripts/dev.sh check

# Individual development tasks
./scripts/dev.sh test           # Run tests only
./scripts/dev.sh fix            # Auto-fix formatting issues
./scripts/dev.sh setup          # Full development environment setup
./scripts/dev.sh clean          # Clean build artifacts

# Python-specific commands
python -m pytest tests/ -v     # Run specific test suites
python -m spending_tracker     # Run bot locally (requires .env file)
spending-tracker               # Alternative way to run bot
```

### Docker-Based Development (Recommended)
```bash
./scripts/local-test.sh              # Test with Docker locally
./scripts/build-and-deploy.sh        # Deploy to production
./scripts/build-and-deploy.sh --skip-test  # Deploy without local testing
```

### Code Quality Tools
```bash
# Individual tools (normally run via dev.sh check)
python -m black spending_tracker/ tests/    # Code formatting
python -m isort spending_tracker/ tests/    # Import sorting
python -m flake8 spending_tracker/ tests/   # Linting
python -m mypy spending_tracker/            # Type checking
```

### Dependencies
```bash
./scripts/update-deps.sh        # Update lock files after changing pyproject.toml
pip install -r requirements.txt # Install base dependencies
pip install -r requirements-dev.txt        # Install development dependencies
pip install -r requirements-telegram.txt   # Install telegram bot dependencies
```

## Project Architecture

### Core Components
- **`spending_tracker/bot.py`**: Main Telegram bot implementation with command handlers and expense workflow
- **`spending_tracker/dal.py`**: Unified Data Access Layer using SQLite with comprehensive CRUD operations
- **`spending_tracker/expense_state.py`**: In-memory state management for draft expenses during user interaction
- **`spending_tracker/__main__.py`**: Entry point that starts the bot

### Database Architecture
**Database**: SQLite with direct SQL queries (no ORM)
- **Tables**: users, currencies, accounts, categories, spending
- **Key relationships**: accounts→currencies, spendings→accounts/categories/users
- **Single DAL class**: All database operations in one unified class for simplified connection management

### Key Design Patterns
- **Async-first**: All bot operations are async by default
- **State management**: In-memory draft expenses with `ExpenseStateManager`
- **Text parsing**: Automatic expense detection from any message containing numbers
- **Inline keyboards**: Interactive UI for expense creation and editing
- **Auto-registration**: Users are automatically registered on first interaction

### Test Architecture
- **158 total tests**: 99 DAL tests + 59 bot/state tests
- **Testing tools**: pytest with pytest-asyncio for async operations
- **Mocking**: Uses MagicMock for Telegram objects to avoid attribute restrictions
- **Test isolation**: Separate test instances for state management
- **Coverage**: Command handlers, text parsing, callbacks, user management, draft expenses

## Environment and Configuration

### Required Environment Variables
- **`TELEGRAM_BOT_TOKEN`**: Your bot token from @BotFather (stored in `.env` file)

### Configuration Files
- **`.env`**: Environment variables (create from `.env.example` if needed)
- **`pyproject.toml`**: Project configuration, dependencies, and tool settings
- **`requirements*.txt`**: Locked dependency files generated by pip-tools

### Python Version
- **Minimum**: Python 3.12+ (available in Ubuntu 24.04 LTS by default)

## Development Workflow Requirements

### Mandatory Code Quality Checks
After completing ANY task, you MUST run:
```bash
./scripts/dev.sh check
```
This runs formatting (black), linting (flake8), type checking (mypy), and tests. ALL must pass.

### Testing Strategy
- **TDD approach**: Write tests first, then implementation
- **Comprehensive coverage**: Test both success and error cases
- **Async testing**: Use pytest-asyncio for bot functionality
- **Database testing**: DAL tests use temporary SQLite files for isolation

### Commit Guidelines
- Use short, descriptive commit messages in English
- Only commit when all code quality checks pass
- Never commit sensitive information (tokens, keys)

## Bot Functionality

### Current Commands
- `/start` - Welcome message and introduction
- `/help` - Show available commands
- `/status` - Check bot status (includes user count)
- `/about` - Information about the bot
- `/users` - List all registered users

### Expense Tracking Workflow
1. **Text message with number** → Bot detects potential expense
2. **Draft creation** → Creates `DraftExpense` with inline keyboard
3. **Category/Account selection** → User selects via inline buttons
4. **Save/Cancel** → Expense saved to database or cancelled
5. **Confirmation** → Shows saved expense details

### Key Features
- **Auto-detection**: Numbers in text messages trigger expense workflow
- **Smart defaults**: Uses first category and account by priority
- **Interactive UI**: Inline keyboards for expense management
- **Validation**: Ensures all required fields before saving
- **State persistence**: Draft expenses maintained during user interaction

## Development Priorities

### Next Priority Tasks
1. Add viewing commands: `/spending`, `/stats`, `/month`
2. Account management: `/accounts` command to manage user accounts
3. Category management: `/categories` command
4. Enhanced expense features: Edit existing expenses, add notes
5. Reporting: Monthly/weekly summaries and analytics

### Code Style Preferences
- Follow existing patterns in `bot.py` and `dal.py`
- Use type hints throughout (`mypy` enforcement)
- Comprehensive error handling with user-friendly messages
- Update `ARCHITECTURE.md` for significant architectural changes
- Maintain 120-character line length (black configuration)

## Database Schema

### Core Tables
- **users**: User information and Telegram integration
- **currencies**: Currency definitions (EUR, USD, BYN, etc.)
- **accounts**: Financial accounts with currency and optional IBAN
- **categories**: Global spending categories with sort ordering
- **spendings**: Individual spending records with full tracking

### Key DAL Methods
- Currency operations: `create_currency()`, `get_currency_by_code()`, etc.
- Account operations: `create_account()`, `get_all_accounts_with_currency()`, etc.
- Category operations: `create_category()`, `get_all_categories()`, etc.
- Spending operations: `create_spending()`, `get_spending_by_id_with_details()`, etc.
- User operations: `create_user()`, `get_user_by_telegram_id()`, etc.

## Deployment

The project uses Docker-based deployment with emphasis on local testability:

### Local Development
```bash
./scripts/local-test.sh    # Full local testing with Docker
```

### Production Deployment
```bash
./scripts/build-and-deploy.sh    # Build locally, deploy to production
```

### Key Principles
- Build locally, deploy remotely (no source code on production)
- Full testability of all components
- Immutable deployments using Docker images
- Minimal production dependencies (only Docker required)

## Important Notes

- **Never use Python 3.13-specific features** - project targets Python 3.12+
- **Always test database operations** with both success and failure scenarios
- **Use async/await** for all bot operations
- **Maintain state isolation** in tests to prevent interference
- **Update documentation** when making architectural changes
- **Environment configuration** is handled via `.env` files in all environments
